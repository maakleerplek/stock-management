# Caddyfile for Stock Management System + InvenTree

# Global options - set default SNI for IP access
{
	default_sni 192.168.68.65
}

# Logging
(log_common) {
	log {
		output file /var/log/caddy/{args[0]}.access.log
	}
}

# CORS headers
(cors-headers) {
	header Allow GET,HEAD,OPTIONS
	header Access-Control-Allow-Origin *
	header Access-Control-Allow-Methods GET,HEAD,OPTIONS
	header Access-Control-Allow-Headers Authorization,Content-Type,User-Agent

	@cors_preflight{args[0]} method OPTIONS
	handle @cors_preflight{args[0]} {
		respond "" 204
	}
}

# Common settings
(common) {
	encode gzip
	request_body {
		max_size 100MB
	}
}

# Stock app routes
(stock-routes) {
	handle_path /api/* {
		reverse_proxy backend:8001
	}
	handle {
		reverse_proxy frontend:80
	}
}

# InvenTree routes (with auth for external access)
(inventree-routes) {
	handle_path /static/* {
		import cors-headers static
		root * /var/www/static
		file_server
	}
	handle_path /media/* {
		import cors-headers media
		root * /var/www/media
		file_server
		header Content-Disposition attachment
		forward_auth http://inventree-server:8000 {
			uri /auth/
		}
	}
	reverse_proxy http://inventree-server:8000 {
		header_down -X-Frame-Options
		header_down -Content-Security-Policy
	}
}

# InvenTree routes for IP access (spoofs Host header to match SITE_URL)
(inventree-routes-ip) {
	handle_path /static/* {
		import cors-headers static
		root * /var/www/static
		file_server
	}
	handle_path /media/* {
		import cors-headers media
		root * /var/www/media
		file_server
		header Content-Disposition attachment
		forward_auth http://inventree-server:8000 {
			uri /auth/
			header_up Host inventree.localhost
			header_up X-Forwarded-Host inventree.localhost
			header_up X-Forwarded-Proto https
		}
	}
	reverse_proxy http://inventree-server:8000 {
		header_up Host inventree.localhost
		header_up X-Forwarded-Host inventree.localhost
		header_up X-Forwarded-Proto https
		header_up X-Forwarded-Port 443
		header_down -X-Frame-Options
		header_down -Content-Security-Policy
	}
}

# =============================================================================
# LOCALHOST ACCESS (HTTPS)
# =============================================================================

stock.localhost {
	tls internal
	import log_common stock
	import common
	import stock-routes
}

inventree.localhost {
	tls internal
	import log_common inventree
	import common
	import inventree-routes
}

# =============================================================================
# NETWORK IP ACCESS (HTTPS)
# =============================================================================

192.168.68.65 {
	tls internal
	import log_common stock-ip
	import common
	import stock-routes
}

192.168.68.65:8443 {
	tls internal
	import log_common inventree-ip
	import common
	import inventree-routes-ip
}

# =============================================================================
# INTERNAL MEDIA SERVER (for backend image proxy - no auth required)
# =============================================================================

:8081 {
	import log_common internal-media

	# Serve media files without authentication (internal use only)
	handle_path /media/* {
		root * /var/www/media
		file_server
	}

	# Serve static files without authentication
	handle_path /static/* {
		root * /var/www/static
		file_server
	}

	# Health check
	handle /health {
		respond "ok" 200
	}
}
