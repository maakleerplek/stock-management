import{ag as oe,r as o,ab as t,j as s,N as _e,d as f,ao as c,bc as d,aO as m,an as E,$ as he,az as be,b5 as X,c8 as J,as as j,S as xe}from"./index-DjOBj_Ai.js";import{A as fe}from"./AdminButton-B8c0S9L9.js";import{P as Z}from"./PrimaryActionButton-BAA_Awc0.js";import{u as ke,d as ye,R as Se,c as je,a as ge,I as Ie,B as Ce,P as Re,O as Ae,E as Ee,b as Pe,H as Oe,C as De}from"./InvenTreeTable-C-s5lvnS.js";import{I as we,D as G,a as Fe}from"./InstanceDetail-DPGTPy9_.js";import{D as Me,A as Le,N as Te}from"./NotesPanel-Gq5AAnCV.js";import{a as ve,p as ee,al as Ne,aD as le,a1 as qe,y as Be,S as te,aq as Ge,aN as We}from"./ThemeContext-BjJu0IKI.js";import{P as ze}from"./PageDetail-1HLwiKVO.js";import{P as He}from"./PanelGroup-_Eigw1UV.js";import{q as Y,Q as Ue,c as x,j as ne,e as Ke,m as Ve,aa as Ze,aq as Ye,g as Qe}from"./Filter-CpWhllKn.js";import{a as Q}from"./formatters-Dkpc25sQ.js";import{d as se,e as $e,f as Xe,u as ae}from"./SalesOrderForms-EpMC8M0_.js";import{u as Je}from"./UseInstance-BYH4ds5B.js";import{u as et}from"./UseStatusCodes-BH1R2YPA.js";import{B as tt}from"./BuildOrderTable-kSdveWqR.js";import{I as st,E as at}from"./ExtraLineItemTable-Cr0OVPmZ.js";import{S as de}from"./SalesOrderAllocationTable-CViFzEk8.js";import{A as re}from"./ActionButton-D4nRdKaB.js";import{P as ie}from"./index-_kfXKtfq.js";import{O as rt}from"./OrderPartsWizard-CtcPC0ec.js";import{u as it}from"./BuildForms-BNnXhzVm.js";import{D as ot,b as lt,h as nt,k as dt,L as ct,l as mt}from"./ColumnRenderers-BCeqgJNS.js";import{R as pt}from"./RowExpansionIcon-CUnOv-Ch.js";import{b as ut}from"./IconChevronDown-I6OOyduR.js";import{S as _t}from"./SalesOrderShipmentTable-DfK2wxqY.js";import{I as ht}from"./IconBookmark-DTqUQJe4.js";import"./DesktopAppView-D6tHFi_e.js";import"./QRCode-BL-P7mX-.js";import"./browser-JUP5PmmS.js";import"./IconDotsVertical-CGvw5eIR.js";import"./IconTags-Bukq1non.js";import"./YesNoButton-CYsvXLSb.js";import"./ModelType-BxY4rynO.js";import"./GenericErrorPage-BWQWzpn2.js";import"./NotFound-BksZ8Fp_.js";import"./PermissionDenied-CPiNkqvu.js";import"./use-hover-CbuFBCOT.js";import"./index-Chjiymov.js";import"./AttachmentLink-EwW6behJ.js";import"./PageTitle-CaObz4lR.js";import"./PluginUIFeature-DWPwHUQS.js";import"./RemoteComponent-CrOPmrx3.js";import"./IconUsers-DgSduCbv.js";import"./IconAddressBook-0_3zwfXJ.js";import"./CommonForms-B8LSJp62.js";import"./UseStockAdjustActions-B7uQUwuU.js";import"./CompanyForms-BrBn0vUb.js";import"./IconAt-B6wo_srX.js";import"./IconChevronRight-BBTCuiZt.js";function bt({orderId:p,orderDetailRefresh:h,currency:b,customerId:e,editable:u}){const _=ve(),i=oe(),r=ke("sales-order-line-item"),l=o.useMemo(()=>[{accessor:"part",sortable:!0,switchable:!1,minWidth:175,render:a=>s.jsxs(_e,{wrap:"nowrap",children:[a.part_detail?.virtual||s.jsx(pt,{enabled:a.allocated,expanded:r.isRowExpanded(a.pk)}),s.jsx(mt,{part:a.part_detail})]})},{accessor:"part_detail.IPN",title:t._({id:"3wXEsN"}),switchable:!0},ot({accessor:"part_detail.description"}),{accessor:"reference",sortable:!1,switchable:!0},lt({}),nt({accessor:"quantity",sortable:!0}),{accessor:"sale_price",render:a=>Q(a.sale_price,{currency:a.sale_price_currency})},{accessor:"total_price",title:t._({id:"KyZVKD"}),render:a=>Q(a.sale_price,{currency:a.sale_price_currency,multiplier:a.quantity})},dt({accessor:"target_date",sortable:!0,title:t._({id:"ZmykKo"})}),{accessor:"stock",title:t._({id:"oGd3rK"}),render:a=>{if(a.part_detail?.virtual)return s.jsx(f,{size:"sm",fs:"italic",children:t._({id:"A2gkIb"})});const A=a?.available_stock??0,S=a?.available_variant_stock??0,K=A+S,ue=Math.max(a.quantity-a.allocated-a.shipped,0);let V,$=`${Y(K)}`;const B=[];return K<=0?(V="red",$=t._({id:"a5n/wL"})):K<ue&&(V="orange"),S>0&&B.push(s.jsx(f,{size:"sm",children:t._({id:"LdvJ9e"})})),a.building>0&&B.push(s.jsxs(f,{size:"sm",children:[t._({id:"G1xXyB"}),": ",Y(a.building)]})),a.on_order>0&&B.push(s.jsxs(f,{size:"sm",children:[t._({id:"/MB+gl"}),": ",Y(a.on_order)]})),s.jsx(Ue,{value:s.jsx(f,{c:V,children:$}),extra:B,title:t._({id:"odasNw"})})}},{accessor:"allocated",sortable:!0,render:a=>a.part_detail?.virtual?s.jsx(f,{size:"sm",fs:"italic",children:t._({id:"A2gkIb"})}):s.jsx(ie,{progressLabel:!0,value:a.allocated,maximum:a.quantity})},{accessor:"shipped",sortable:!0,render:a=>a.part_detail?.virtual?s.jsx(f,{size:"sm",fs:"italic",children:t._({id:"A2gkIb"})}):s.jsx(ie,{progressLabel:!0,value:a.shipped,maximum:a.quantity})},{accessor:"notes"},ct({accessor:"link"})],[r.isRowExpanded]),[g,P]=o.useState(0),[I,W]=o.useState(null),[O,k]=o.useState({}),z=se({orderId:p,customerId:e,create:!0,currency:b}),C=x({url:c.sales_order_line_list,title:t._({id:"pwb7Yo"}),fields:z,initialData:{...O,sale_price_currency:b},onFormSuccess:h,table:r}),T=se({orderId:p,customerId:e,create:!1}),D=ne({url:c.sales_order_line_list,pk:g,title:t._({id:"vgosWS"}),fields:T,onFormSuccess:h,table:r}),w=Ke({url:c.sales_order_line_list,pk:g,title:t._({id:"tpKh8C"}),onFormSuccess:h,table:r}),v=$e({itemId:g,orderId:p}),N=x({url:c.sales_order_allocate_serials,pk:p,title:t._({id:"AZE5KS"}),preFormContent:I?s.jsx(he,{withBorder:!0,p:"sm",children:s.jsx(Ze,{instance:I})}):void 0,initialData:O,fields:v,table:r}),H=it({create:!0,modalId:"build-order-create-from-sales-order"}),q=x({url:c.build_order_list,title:t._({id:"UcPKar"}),modalId:"build-order-create-from-sales-order",fields:H,initialData:O,follow:!0,modelType:d.build}),[n,R]=o.useState([]),y=Xe({orderId:p,lineItems:n,onFormSuccess:()=>{r.refreshTable(),r.clearSelectedRecords()}}),[F,M]=o.useState([]),L=rt({parts:F}),U=o.useMemo(()=>[{name:"allocated",label:t._({id:"A/ybx7"}),description:t._({id:"Rk+ZGQ"})},{name:"completed",label:t._({id:"qqWcBV"}),description:t._({id:"x7Nm8D"})}],[]),ce=o.useMemo(()=>[s.jsx(Ve,{tooltip:t._({id:"pwb7Yo"}),onClick:()=>{k({order:p}),C.open()},hidden:!u||!i.hasAddRole(m.sales_order)},"add-line-item"),s.jsx(re,{hidden:!i.hasAddRole(m.purchase_order),disabled:!r.hasSelectedRecords,tooltip:t._({id:"3u5ICq"}),icon:s.jsx(ee,{}),color:"blue",onClick:()=>{M(r.selectedRecords.map(a=>a.part_detail)),L.openWizard()}},"order-parts"),s.jsx(re,{tooltip:t._({id:"L1LMmH"}),icon:s.jsx(ut,{}),disabled:!r.hasSelectedRecords,color:"green",onClick:()=>{R(r.selectedRecords.filter(a=>a.allocated<a.quantity)),y.open()}},"allocate-stock")],[i,p,r.hasSelectedRecords,r.selectedRecords]),me=o.useCallback(a=>{const A=(a?.allocated??0)>(a?.quantity??0),S=a?.part_detail?.virtual??!1;return[ye({title:t._({id:"4BxQBj"}),modelType:d.part,modelId:a.part,navigate:_,hidden:!i.hasViewRole(m.part)}),{hidden:A||S||!u||!i.hasChangeRole(m.sales_order),title:t._({id:"L1LMmH"}),icon:s.jsx(st,{}),color:"green",onClick:()=>{R([a]),y.open()}},{hidden:!a?.part_detail?.trackable||A||S||!u||!i.hasChangeRole(m.sales_order),title:t._({id:"EIkxpC"}),icon:s.jsx(Ne,{}),color:"green",onClick:()=>{P(a.pk),W(a?.part_detail??null),k({quantity:a.quantity-a.allocated}),N.open()}},{hidden:A||S||!i.hasAddRole(m.build)||!a?.part_detail?.assembly,title:t._({id:"NH34YB"}),icon:s.jsx(le,{}),color:"blue",onClick:()=>{k({part:a.part,quantity:(a?.quantity??1)-(a?.allocated??0),sales_order:p}),q.open()}},{hidden:A||S||!i.hasAddRole(m.purchase_order)||!a?.part_detail?.purchaseable,title:t._({id:"G4SnGh"}),icon:s.jsx(ee,{}),color:"blue",onClick:()=>{M([a.part_detail]),L.openWizard()}},Se({hidden:!u||!i.hasChangeRole(m.sales_order),onClick:()=>{P(a.pk),D.open()}}),je({hidden:!u||!i.hasAddRole(m.sales_order),onClick:()=>{k(a),C.open()}}),ge({hidden:!u||!i.hasDeleteRole(m.sales_order),onClick:()=>{P(a.pk),w.open()}})]},[_,i,u]),pe=o.useMemo(()=>({allowMultiple:!0,expandable:({record:a})=>a?.part_detail?.virtual?!1:r.isRowExpanded(a.pk)||a.allocated>0,content:({record:a})=>s.jsx(de,{showOrderInfo:!1,showPartInfo:!1,orderId:p,lineItemId:a.pk,partId:a.part,allowEdit:!0,modelTarget:d.stockitem,modelField:"item",isSubTable:!0})}),[p,r.isRowExpanded]);return s.jsxs(s.Fragment,{children:[D.modal,w.modal,C.modal,q.modal,N.modal,y.modal,L.wizard,s.jsx(Ie,{url:E(c.sales_order_line_list),tableState:r,columns:l,props:{enableSelection:!0,enableDownload:!0,params:{order:p,part_detail:!0},rowActions:me,tableActions:ce,tableFilters:U,rowExpansion:pe}})]})}function ps(){const{id:p}=qe(),h=oe(),b=be(),{instance:e,instanceQuery:u,refreshInstance:_}=Je({endpoint:c.sales_order_list,pk:p,params:{customer_detail:!0}}),i=o.useMemo(()=>e.order_currency||e.customer_detail?.currency||b.getSetting("INVENTREE_DEFAULT_CURRENCY"),[e,b]),r=o.useMemo(()=>{if(u.isFetching)return s.jsx(X,{});const n=[{type:"text",name:"reference",label:t._({id:"N2C89m"}),copy:!0},{type:"text",name:"customer_reference",label:t._({id:"ZVUe1A"}),copy:!0,icon:"reference",hidden:!e.customer_reference},{type:"link",name:"customer",icon:"customers",label:t._({id:"876pfE"}),model:d.company},{type:"text",name:"description",label:t._({id:"Nu4oKW"}),copy:!0},{type:"status",name:"status",label:t._({id:"uAQUqI"}),model:d.salesorder},{type:"status",name:"status_custom_key",label:t._({id:"4DvUAJ"}),model:d.salesorder,icon:"status",hidden:!e.status_custom_key||e.status_custom_key==e.status}],R=[{type:"progressbar",name:"completed",icon:"progress",label:t._({id:"qgs95u"}),total:e.line_items,progress:e.completed_lines,hidden:!e.line_items},{type:"progressbar",name:"shipments",icon:"shipment",label:t._({id:"polrQd"}),total:e.shipments_count,progress:e.completed_shipments_count,hidden:!e.shipments_count},{type:"text",name:"currency",label:t._({id:"0UZTSq"}),value_formatter:()=>i},{type:"text",name:"total_price",label:t._({id:"A6C0pv"}),value_formatter:()=>Q(e?.total_price,{currency:i})}],y=[{type:"link",external:!0,name:"link",label:t._({id:"yzF66j"}),copy:!0,hidden:!e.link},{type:"text",name:"address",label:t._({id:"g6yaYE"}),icon:"address",value_formatter:()=>e.address_detail?s.jsx(Ye,{instance:e.address_detail}):s.jsx(f,{size:"sm",c:"red",children:t._({id:"dm2vYF"})})},{type:"text",name:"contact_detail.name",label:t._({id:"jfC/xh"}),icon:"user",copy:!0,hidden:!e.contact},{type:"text",name:"contact_detail.email",label:t._({id:"41BQ3k"}),icon:"email",copy:!0,hidden:!e.contact_detail?.email},{type:"text",name:"contact_detail.phone",label:t._({id:"P1x5uo"}),icon:"phone",copy:!0,hidden:!e.contact_detail?.phone},{type:"text",name:"project_code_label",label:t._({id:"Sdfr6G"}),icon:"reference",copy:!0,hidden:!e.project_code},{type:"text",name:"responsible",label:t._({id:"XQACoK"}),badge:"owner",hidden:!e.responsible}],F=[{type:"date",name:"creation_date",label:t._({id:"FNcMGM"}),copy:!0,hidden:!e.creation_date},{type:"date",name:"issue_date",label:t._({id:"M1cChr"}),icon:"calendar",copy:!0,hidden:!e.issue_date},{type:"date",name:"start_date",label:t._({id:"D3iCkb"}),icon:"calendar",hidden:!e.start_date,copy:!0},{type:"date",name:"target_date",label:t._({id:"ZmykKo"}),hidden:!e.target_date,copy:!0},{type:"date",name:"shipment_date",label:t._({id:"41ha49"}),hidden:!e.shipment_date,copy:!0}];return s.jsxs(we,{children:[s.jsxs(J,{grow:!0,children:[s.jsx(Me,{appRole:m.purchase_order,apiPath:c.company_list,src:e.customer_detail?.image,pk:e.customer}),s.jsx(J.Col,{span:{base:12,sm:8},children:s.jsx(G,{fields:n,item:e})})]}),s.jsx(G,{fields:R,item:e}),s.jsx(G,{fields:y,item:e}),s.jsx(G,{fields:F,item:e})]})},[e,i,u]),l=et({modelType:d.salesorder}),g=o.useMemo(()=>e.status!=l.COMPLETE&&e.status!=l.CANCELLED?!0:b.isSet("SALESORDER_EDIT_COMPLETED_ORDERS"),[b,e.status,l]),P=ae({}),I=ne({url:c.sales_order_list,pk:e.pk,title:t._({id:"nEK4wx"}),fields:P,onFormSuccess:()=>{_()}}),W=ae({duplicateOrderId:e.pk}),O=o.useMemo(()=>{const n={...e};return delete n.reference,n},[e]),k=x({url:c.sales_order_list,title:t._({id:"VzdnWM"}),fields:W,initialData:O,follow:!0,modelType:d.salesorder}),z=o.useMemo(()=>[{name:"detail",label:t._({id:"Tol4BF"}),icon:s.jsx(Be,{}),content:r},{name:"line-items",label:t._({id:"SgduFH"}),icon:s.jsx(Ge,{}),content:s.jsxs(j,{multiple:!0,defaultValue:["line-items","extra-items"],children:[s.jsxs(j.Item,{value:"line-items",children:[s.jsx(j.Control,{children:s.jsx(te,{size:"lg",children:t._({id:"SgduFH"})})}),s.jsx(j.Panel,{children:s.jsx(bt,{orderId:e.pk,orderDetailRefresh:_,currency:i,customerId:e.customer,editable:g})})]},"lineitems"),s.jsxs(j.Item,{value:"extra-items",children:[s.jsx(j.Control,{children:s.jsx(te,{size:"lg",children:t._({id:"l11DG/"})})}),s.jsx(j.Panel,{children:s.jsx(at,{endpoint:c.sales_order_extra_line_list,orderId:e.pk,editable:g,orderDetailRefresh:_,currency:i,role:m.sales_order})})]},"extraitems")]})},{name:"shipments",label:t._({id:"aljM0q"}),icon:s.jsx(We,{}),content:s.jsx(_t,{orderId:e.pk,customerId:e.customer})},{name:"allocations",label:t._({id:"MD2yP5"}),icon:s.jsx(ht,{}),content:s.jsx(de,{orderId:e.pk,showPartInfo:!0,allowEdit:!0,modelField:"item",modelTarget:d.stockitem})},{name:"build-orders",label:t._({id:"RCVhIP"}),icon:s.jsx(le,{}),hidden:!h.hasViewRole(m.build),content:e?.pk?s.jsx(tt,{salesOrderId:e.pk}):s.jsx(X,{})},Le({model_type:d.salesorder,model_id:e.pk}),Te({model_type:d.salesorder,model_id:e.pk})],[e,p,h,l,h]),C=x({url:E(c.sales_order_issue,e.pk),title:t._({id:"Zk75Wf"}),onFormSuccess:_,preFormWarning:t._({id:"lLiNZC"}),successMessage:t._({id:"R/WvFK"})}),T=x({url:E(c.sales_order_cancel,e.pk),title:t._({id:"GYdhXE"}),onFormSuccess:_,preFormWarning:t._({id:"MPFqR0"}),successMessage:t._({id:"H5qWhm"})}),D=x({url:E(c.sales_order_hold,e.pk),title:t._({id:"Pgi6wT"}),onFormSuccess:_,preFormWarning:t._({id:"3Wfk51"}),successMessage:t._({id:"0NH/ob"})}),w=x({url:E(c.sales_order_complete,e.pk),title:t._({id:"tMUAZW"}),onFormSuccess:_,preFormWarning:t._({id:"huukBM"}),successMessage:t._({id:"NloAZ8"}),fields:{accept_incomplete:{}}}),v=x({url:E(c.sales_order_complete,e.pk),title:t._({id:"O1h5Uc"}),onFormSuccess:_,preFormWarning:t._({id:"DYITap"}),successMessage:t._({id:"W7TghJ"}),fields:{accept_incomplete:{}}}),N=o.useMemo(()=>{const n=h.hasChangeRole(m.sales_order),R=n&&(e.status==l.PENDING||e.status==l.ON_HOLD),y=n&&(e.status==l.PENDING||e.status==l.ON_HOLD||e.status==l.IN_PROGRESS),F=n&&(e.status==l.PENDING||e.status==l.IN_PROGRESS),M=b.isSet("SALESORDER_SHIP_COMPLETE"),L=!M&&n&&e.status==l.IN_PROGRESS,U=n&&(e.status==l.SHIPPED||M&&e.status==l.IN_PROGRESS);return[s.jsx(Z,{title:t._({id:"WajCDs"}),icon:"issue",hidden:!R,color:"blue",onClick:C.open}),s.jsx(Z,{title:t._({id:"7I7mfp"}),icon:"deliver",hidden:!L,color:"blue",onClick:w.open}),s.jsx(Z,{title:t._({id:"NPZqBL"}),icon:"complete",hidden:!U,color:"green",onClick:v.open}),s.jsx(fe,{model:d.salesorder,id:e.pk}),s.jsx(Ce,{model:d.salesorder,pk:e.pk,hash:e?.barcode_hash}),s.jsx(Re,{modelType:d.salesorder,items:[e.pk],enableReports:!0,enableLabels:!0}),s.jsx(Ae,{tooltip:t._({id:"/IKytX"}),actions:[Ee({hidden:!n,onClick:I.open,tooltip:t._({id:"mVeaUg"})}),Pe({hidden:!h.hasAddRole(m.sales_order),onClick:k.open,tooltip:t._({id:"oi/3Pq"})}),Oe({tooltip:t._({id:"20mLBC"}),hidden:!F,onClick:D.open}),De({tooltip:t._({id:"tVJk4q"}),hidden:!y,onClick:T.open})]})]},[h,e,l,b]),H=o.useMemo(()=>u.isLoading?[]:[s.jsx(Qe,{status:e.status_custom_key,type:d.salesorder,options:{size:"lg"}},e.pk)],[e,u]),q=o.useMemo(()=>{let n=e.customer_detail?.name||"";return e.customer_reference&&(n+=` (${e.customer_reference})`),n},[e]);return s.jsxs(s.Fragment,{children:[C.modal,T.modal,D.modal,w.modal,v.modal,I.modal,k.modal,s.jsx(Fe,{query:u,requiredRole:m.sales_order,children:s.jsxs(xe,{gap:"xs",children:[s.jsx(ze,{title:`${t._({id:"LozYBo"})}: ${e.reference}`,subtitle:q,imageUrl:e.customer_detail?.image,badges:H,actions:N,breadcrumbs:[{name:t._({id:"mUv9U4"}),url:"/sales/"}],lastCrumb:[{name:e.reference,url:`/sales/sales-order/${e.pk}`}],editAction:I.open,editEnabled:h.hasChangePermission(d.salesorder)}),s.jsx(He,{pageKey:"salesorder",panels:z,model:d.salesorder,reloadInstance:_,instance:e,id:e.pk})]})})]})}export{ps as default};
//# sourceMappingURL=SalesOrderDetail-DloOIAMz.js.map
