import{K as ye,r as l,ab as e,an as B,ao as k,j as s,N as z,am as ge,aa as Ce,ac as Se,bh as Re,d,bc as w,ag as le,aO as j,$ as we,a7 as Te,aq as $}from"./index-DjOBj_Ai.js";import{A as ve,aH as ee,a as ne,aI as te,p as se,aJ as qe}from"./ThemeContext-BjJu0IKI.js";import{P as Ae}from"./YesNoButton-CYsvXLSb.js";import{c as D,ae as Fe,Q as J,V as Me,$ as Ie,a1 as Le,a0 as Be,Y as ze,Z as De,_ as Oe,S as Ee,m as Pe,q,j as Ve,e as Qe}from"./Filter-CpWhllKn.js";import{u as Ne}from"./DesktopAppView-D6tHFi_e.js";import{f as Je}from"./formatters-Dkpc25sQ.js";import{q as We}from"./PluginUIFeature-DWPwHUQS.js";import{u as X,I as K,d as oe,R as Ue,a as Ze}from"./InvenTreeTable-C-s5lvnS.js";import{j as re,P as de,D as He,B as I,h as Ge,l as Xe}from"./ColumnRenderers-BCeqgJNS.js";import{A as L}from"./ActionButton-D4nRdKaB.js";import{P as G}from"./index-_kfXKtfq.js";import{O as Ke}from"./OrderPartsWizard-CtcPC0ec.js";import{u as Ye,a as $e,b as et}from"./BuildForms-BNnXhzVm.js";import{u as tt}from"./UseStatusCodes-BH1R2YPA.js";import{R as st}from"./RowExpansionIcon-CUnOv-Ch.js";import{b as ae}from"./IconChevronDown-I6OOyduR.js";import{I as ie}from"./IconCircleDashedCheck-FiF_1OHY.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const at=[["path",{d:"M6 21l15 -15l-3 -3l-15 15l3 3",key:"svg-0"}],["path",{d:"M15 6l3 3",key:"svg-1"}],["path",{d:"M9 3a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2",key:"svg-2"}],["path",{d:"M19 13a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2",key:"svg-3"}]],it=ye("outline","wand","Wand",at);function Ct({buildId:c,partId:n}){const S=l.useMemo(()=>c?"build-test-results":"part-test-results",[c]),u=X(S),T=Ne(),{data:p}=ve({queryKey:["build-test-templates",n,c],queryFn:async()=>n?T.get(B(k.part_test_template_list),{params:{part:n,include_inherited:!0,enabled:!0,required:!0}}).then(m=>m.data):[]});l.useEffect(()=>{u.refreshTable()},[p]);const[b,a]=l.useState(0),[x,O]=l.useState(void 0),A=We({partId:n,itemId:b,templateId:x}),F=D({url:B(k.stock_test_result_list),title:e._({id:"VzkBcq"}),fields:A,initialData:{template:x,result:!0},onFormSuccess:()=>u.refreshTable(),successMessage:e._({id:"VivtT0"})}),W=l.useMemo(()=>{const m={...A};return delete m.attachment,delete m.stock_item,m.template.disabled=!1,m},[n,A]),U=l.useCallback((m,f)=>u.selectedRecords.map(h=>({...m,stock_item:h.pk})),[u.selectedIds]),E=D({url:B(k.stock_test_result_list),title:e._({id:"t+Eo6q"}),fields:W,initialData:{result:!0},onFormSuccess:()=>{u.clearSelectedRecords(),u.refreshTable()},processFormData:U,successMessage:e._({id:"1QgWBV"})}),M=l.useMemo(()=>!p||p.length==0?[]:p.map(m=>({accessor:`test_${m.pk}`,title:m.test_name,sortable:!1,switchable:!0,render:f=>{const h=(f.tests||[]).filter(C=>C.template==m.pk).sort((C,N)=>N.pk-C.pk).shift();if(!h||h.result===void 0)return s.jsxs(z,{gap:"xs",wrap:"nowrap",justify:"space-between",children:[s.jsx(ge,{color:"lightblue",variant:"filled",children:e._({id:"4bobEy"})}),s.jsx(Ce,{label:e._({id:"VzkBcq"}),children:s.jsx(Se,{size:"lg",color:"green","aria-label":"add-test-result",variant:"transparent",onClick:C=>{Re(C),a(f.pk),O(m.pk),F.open()},children:s.jsx(ee,{})})})]});const g=[];return h.value&&g.push(s.jsxs(d,{size:"sm",children:[e._({id:"wMHvYH"}),": ",h.value]},"value")),h.notes&&g.push(s.jsxs(d,{size:"sm",children:[e._({id:"1DBGsz"}),": ",h.notes]},"notes")),h.date&&g.push(s.jsxs(d,{size:"sm",children:[e._({id:"mYGY3B"}),": ",Je(h.date)]},"date")),h.user_detail&&g.push(s.jsx(Fe,{instance:h.user_detail},"user")),s.jsx(J,{value:s.jsx(Ae,{value:h.result}),title:m.test_name,extra:g})}})),[p]),P=l.useMemo(()=>[...[{accessor:"stock",title:e._({id:"igx8Og"}),sortable:!0,switchable:!1,render:f=>{if(f.serial)return`# ${f.serial}`;{const y=[];return f.batch&&y.push(s.jsxs(d,{size:"sm",children:[e._({id:"Vea6Aj"}),": ",f.batch]},"batch")),s.jsx(J,{value:s.jsxs(d,{children:[e._({id:"VbWX2u"}),": ",f.quantity]}),title:e._({id:"gILim+"}),extra:y})}}},{accessor:"batch",title:e._({id:"Vea6Aj"}),sortable:!0,switchable:!0},re({accessor:"location_detail"})],...M],[M]),V=l.useMemo(()=>[{name:"is_building",label:e._({id:"BE5Q6v"}),description:e._({id:"AO8gAN"})},Me(),Ie(),Le(),Be(),ze(),De(),Oe(),{name:"status",label:e._({id:"uAQUqI"}),description:e._({id:"+Jr1e4"}),choiceFunction:Ee(w.stockitem)}],[]),v=l.useMemo(()=>[s.jsx(Pe,{tooltip:e._({id:"VzkBcq"}),disabled:!u.hasSelectedRecords,onClick:m=>{E.open()}},"add-test-result")],[u.hasSelectedRecords]),Q=l.useCallback(m=>[{icon:s.jsx(ee,{}),color:"green",title:e._({id:"VzkBcq"}),onClick:f=>{a(m.pk),O(void 0),F.open()}}],[]);return s.jsxs(s.Fragment,{children:[F.modal,E.modal,s.jsx(K,{url:B(k.stock_item_list),tableState:u,columns:P,props:{params:{part_detail:!0,location_detail:!0,tests:!0,build:c},enableSelection:!0,rowActions:Q,tableFilters:V,tableActions:v,modelType:w.stockitem}})]})}function lt({lineItem:c,onEditAllocation:n,onDeleteAllocation:S}){const u=le(),T=ne(),p=X("buildline-subtable"),b=l.useMemo(()=>[de({part:"part_detail"}),{accessor:"quantity",title:e._({id:"VbWX2u"}),render:x=>x.stock_item_detail?.serial?`# ${x.stock_item_detail.serial}`:x.quantity},{accessor:"stock_item_detail.batch",title:e._({id:"rsx3xA"})},re({accessor:"location_detail"})],[]),a=l.useCallback(x=>[oe({title:e._({id:"f6f1i/"}),modelType:w.stockitem,modelId:x.stock_item,navigate:T}),Ue({hidden:!n||!u.hasChangeRole(j.build),onClick:()=>{n?.(x.pk)}}),Ze({hidden:!S||!u.hasDeleteRole(j.build),onClick:()=>{S?.(x.pk)}})],[u,n,S]);return s.jsx(we,{p:"xs",children:s.jsx(K,{tableState:p,columns:b,tableData:c.filteredAllocations??c.allocations,props:{minHeight:200,enableSearch:!1,enableRefresh:!1,enableColumnSwitching:!1,enableFilters:!1,rowActions:a,noRecordsText:""}})})}function St({build:c,output:n,params:S={}}){const u=le(),T=ne(),p=tt({modelType:w.build}),b=l.useMemo(()=>!!n?.pk,[n]),a=X(b?"buildline-output":"buildline"),x=l.useMemo(()=>c?.status==p.PRODUCTION||c?.status==p.PENDING||c?.status==p.ON_HOLD,[c,p]),O=l.useMemo(()=>[{name:"allocated",label:e._({id:"A/ybx7"}),description:e._({id:"/EiduX"})},{name:"consumed",label:e._({id:"XNITBt"}),description:e._({id:"ATuQJ1"})},{name:"available",label:e._({id:"csDS2L"}),description:e._({id:"Dg4tQl"})},{name:"consumable",label:e._({id:"duCsZf"}),description:e._({id:"4xoOP+"})},{name:"optional",label:e._({id:"LLAa/9"}),description:e._({id:"JZ0XU+"})},{name:"assembly",label:e._({id:"WL36Yh"}),description:e._({id:"yTd5+B"})},{name:"testable",label:e._({id:"bJsTOf"}),description:e._({id:"LCdyP7"})},{name:"tracked",label:e._({id:"EaG6cP"}),description:e._({id:"lY29Qz"})}],[]),A=l.useCallback(t=>{const i=t?.bom_item_detail??{},o=[];let r=t?.available_stock;t.available_substitute_stock>0&&(r+=t.available_substitute_stock,o.push(s.jsx(d,{size:"sm",children:e._({id:"XTe+lK"})},"substitite"))),i.allow_variants&&t.available_variant_stock>0&&(r+=t.available_variant_stock,o.push(s.jsx(d,{size:"sm",children:e._({id:"LdvJ9e"})},"variant"))),t.in_production>0&&o.push(s.jsxs(d,{size:"sm",children:[e._({id:"G1xXyB"}),": ",q(t.in_production)]},"production")),t.on_order>0&&o.push(s.jsxs(d,{size:"sm",children:[e._({id:"/MB+gl"}),": ",q(t.on_order)]},"on-order")),t.external_stock>0&&o.push(s.jsxs(d,{size:"sm",children:[e._({id:"e8fwfT"}),": ",q(t.external_stock)]},"external"));const _=r>=t.quantity-t.allocated;return _||o.push(s.jsx(d,{c:"orange",size:"sm",children:e._({id:"R7+e2m"})},"insufficient")),s.jsx(J,{icon:_?"info":"exclamation",iconColor:_?"blue":"orange",value:r>0?`${q(r)}`:s.jsx(d,{c:"red",style:{fontStyle:"italic"},children:e._({id:"a5n/wL"})}),title:e._({id:"oGd3rK"}),extra:o})},[]),F=l.useMemo(()=>[de({accessor:"bom_item",part:"part_detail",ordering:"part",sortable:!0,switchable:!1,render:t=>{const i=t.allocatedQuantity>0;return s.jsxs(z,{wrap:"nowrap",children:[s.jsx(st,{enabled:i,expanded:a.isRowExpanded(t.pk)}),s.jsx(Xe,{part:t.part_detail})]})}}),{accessor:"part_detail.IPN",sortable:!1,title:e._({id:"3wXEsN"})},He({accessor:"part_detail.description"}),{accessor:"bom_item_detail.reference",ordering:"reference",sortable:!0,title:e._({id:"N2C89m"})},I({accessor:"bom_item_detail.optional",ordering:"optional",hidden:b,defaultVisible:!1}),I({accessor:"bom_item_detail.consumable",ordering:"consumable",hidden:b,defaultVisible:!1}),I({accessor:"bom_item_detail.allow_variants",ordering:"allow_variants",hidden:b,defaultVisible:!1}),I({accessor:"bom_item_detail.inherited",ordering:"inherited",title:e._({id:"UF/nv9"}),hidden:b,defaultVisible:!1}),I({accessor:"part_detail.trackable",ordering:"trackable",hidden:b,defaultVisible:!1}),{accessor:"bom_item_detail.quantity",sortable:!0,title:e._({id:"O7oMsT"}),defaultVisible:!1,ordering:"unit_quantity",render:t=>s.jsxs(z,{justify:"space-between",wrap:"nowrap",children:[s.jsx(d,{children:t.bom_item_detail?.quantity}),t?.part_detail?.units&&s.jsxs(d,{size:"xs",children:["[",t.part_detail.units,"]"]})]})},{accessor:"quantity",title:e._({id:"D91mkk"}),sortable:!0,defaultVisible:!1,switchable:!1,render:t=>{const i=[];return t?.bom_item_detail?.setup_quantity&&i.push(s.jsxs(d,{size:"sm",children:[e._({id:"uweQpR"}),":"," ",q(t.bom_item_detail.setup_quantity)]},"setup-quantity")),t?.bom_item_detail?.attrition&&i.push(s.jsxs(d,{size:"sm",children:[e._({id:"SXygdJ"}),": ",t.bom_item_detail.attrition,"%"]},"attrition")),t?.bom_item_detail?.rounding_multiple&&i.push(s.jsxs(d,{size:"sm",children:[e._({id:"RKbJ2k"}),":"," ",t.bom_item_detail.rounding_multiple]},"rounding-multiple")),s.jsx(J,{title:e._({id:"mbcLng"}),extra:i,value:s.jsxs(z,{justify:"space-between",wrap:"nowrap",children:[s.jsx(d,{children:q(t.requiredQuantity)}),t?.part_detail?.units&&s.jsxs(d,{size:"xs",children:["[",t.part_detail.units,"]"]})]})})}},{accessor:"available_stock",sortable:!0,switchable:!1,render:A},{accessor:"in_production",render:t=>t.scheduled_to_build>0?s.jsx(G,{progressLabel:!0,value:t.in_production,maximum:t.scheduled_to_build}):t.part_detail?.is_assembly?0:"-"},Ge({accessor:"on_order",defaultVisible:!1}),{accessor:"allocated",switchable:!1,sortable:!0,hidden:!x,minWidth:125,render:t=>{if(t?.bom_item_detail?.consumable)return s.jsx(d,{size:"sm",style:{fontStyle:"italic"},children:e._({id:"f/GbFw"})});const i=t.allocatedQuantity??0;let o=Math.max(0,t.quantity-t.consumed);return n?.pk&&(o=t.bom_item_detail?.quantity),i<=0&&o<=0?s.jsxs(z,{gap:"xs",wrap:"nowrap",children:[s.jsx(Te,{size:16,color:"green"}),s.jsx(d,{size:"sm",style:{fontStyle:"italic"},children:t.consumed>=t.quantity?e._({id:"e02p4q"}):e._({id:"rHo/AM"})})]}):s.jsx(G,{progressLabel:!0,value:i,maximum:o})}},{accessor:"consumed",sortable:!0,hidden:!!n?.pk,minWidth:125,render:t=>t?.bom_item_detail?.consumable?s.jsx(d,{style:{fontStyle:"italic"},children:e._({id:"f/GbFw"})}):s.jsx(G,{progressLabel:!0,value:t.consumed,maximum:t.requiredQuantity})}],[b,x,a,n]),W=Ye({create:!0,modalId:"new-build-order"}),[U,E]=l.useState({}),[M,P]=l.useState(null),[V,v]=l.useState([]),Q=D({url:k.build_order_list,title:e._({id:"UcPKar"}),fields:W,modalId:"new-build-order",initialData:U,follow:!0,modelType:w.build}),m=D({url:k.build_order_auto_allocate,pk:c.pk,title:e._({id:"L1LMmH"}),fields:{location:{filters:{structural:!1}},exclude_location:{},interchangeable:{},substitutes:{},optional_items:{}},initialData:{location:c.take_from,interchangeable:!0,substitutes:!0,optional_items:!1},successMessage:e._({id:"xYIlpM"}),table:a,preFormContent:s.jsx($,{color:"green",title:e._({id:"PjEJ0F"}),children:s.jsx(d,{children:e._({id:"E2byp7"})})})}),f=$e({build:c,output:n,outputId:n?.pk??null,buildId:c.pk,lineItems:V,onFormSuccess:()=>{a.clearSelectedRecords(),a.refreshTable()}}),y=D({url:k.build_order_deallocate,pk:c.pk,title:e._({id:"ZZL0Jx"}),fields:{build_line:{hidden:!0},output:{hidden:!0}},initialData:{build_line:M,output:n?.pk??null},preFormContent:s.jsx($,{color:"red",title:e._({id:"ZZL0Jx"}),children:M==null?s.jsx(d,{children:e._({id:"9dNtWo"})}):s.jsx(d,{children:e._({id:"L01aET"})})}),successMessage:e._({id:"er7tfw"}),onFormSuccess:()=>{a.clearSelectedRecords(),a.refreshTable()}}),[h,g]=l.useState(0),C=Ve({url:k.build_item_list,pk:h,title:e._({id:"Tqnsor"}),fields:{stock_item:{disabled:!0},quantity:{}},onFormSuccess:a.refreshTable}),N=Qe({url:k.build_item_list,pk:h,title:e._({id:"nV5okC"}),onFormSuccess:a.refreshTable}),[ce,Y]=l.useState([]),Z=Ke({parts:ce}),H=et({buildId:c.pk,buildLines:V,onFormSuccess:()=>{a.clearSelectedRecords(),a.refreshTable()}}),ue=l.useCallback(t=>{const i=t.part_detail??{},o=c.status==p.PRODUCTION,r=t.bom_item_detail?.consumable??!1,_=i?.trackable??!1,R=!!n?.pk,be=Math.max(0,t.quantity-t.consumed-t.allocated),he=o&&!r&&!_&&t.allocated>0&&u.hasChangeRole(j.build),fe=o&&!r&&u.hasChangeRole(j.build)&&be>0&&t.trackable==R,xe=o&&!r&&u.hasChangeRole(j.build)&&t.allocated>0&&t.trackable==R,ke=!r&&u.hasAddRole(j.purchase_order)&&i.purchaseable,je=!r&&u.hasAddRole(j.build)&&i.assembly;return[{icon:s.jsx(ae,{}),title:e._({id:"L1LMmH"}),hidden:!fe,color:"green",onClick:()=>{v([t]),f.open()}},{icon:s.jsx(ie,{}),title:e._({id:"8nBqTf"}),color:"green",hidden:!he||R,onClick:()=>{v([t]),H.open()}},{icon:s.jsx(te,{}),title:e._({id:"ZZL0Jx"}),hidden:!xe,color:"red",onClick:()=>{P(t.pk),y.open()}},{icon:s.jsx(se,{}),title:e._({id:"cUzrZK"}),hidden:!ke,color:"blue",onClick:()=>{Y([t.part_detail]),Z.openWizard()}},{icon:s.jsx(qe,{}),title:e._({id:"vgTd7I"}),hidden:!je,color:"blue",onClick:()=>{E({part:t.part,parent:c.pk,quantity:t.quantity-t.allocated}),Q.open()}},oe({title:e._({id:"4BxQBj"}),modelType:w.part,modelId:t.part,navigate:T})]},[u,T,n,c,p]),me=l.useMemo(()=>{const t=c.status==p.PRODUCTION,i=u.hasChangeRole(j.build),o=t&&i;return[s.jsx(L,{icon:s.jsx(it,{}),tooltip:e._({id:"PjEJ0F"}),hidden:!o||b,color:"blue",onClick:()=>{m.open()}},"auto-allocate"),s.jsx(L,{hidden:!u.hasAddRole(j.purchase_order),disabled:!a.hasSelectedRecords,icon:s.jsx(se,{}),color:"blue",tooltip:e._({id:"3u5ICq"}),onClick:()=>{Y(a.selectedRecords.filter(r=>r.part_detail?.purchaseable&&r.part_detail?.active).map(r=>r.part_detail)),Z.openWizard()}},"order-parts"),s.jsx(L,{icon:s.jsx(ae,{}),tooltip:e._({id:"L1LMmH"}),hidden:!o,disabled:!a.hasSelectedRecords,color:"green",onClick:()=>{let r=a.selectedRecords.filter(_=>_.allocatedQuantity<_.requiredQuantity).filter(_=>!_.bom_item_detail?.consumable);b?r=r.filter(_=>_.trackable):r=r.filter(_=>!_.trackable),v(r),f.open()}},"allocate-stock"),s.jsx(L,{icon:s.jsx(te,{}),tooltip:e._({id:"ZZL0Jx"}),hidden:!o||b,disabled:a.hasSelectedRecords,color:"red",onClick:()=>{P(null),y.open()}},"deallocate-stock"),s.jsx(L,{icon:s.jsx(ie,{}),tooltip:e._({id:"8nBqTf"}),hidden:!o||b,disabled:!a.hasSelectedRecords,color:"green",onClick:()=>{v(a.selectedRecords),H.open()}},"consume-stock")]},[u,c,p,b,a.hasSelectedRecords,a.selectedRecords]),_e=l.useCallback(t=>t.map(i=>{let o=[...i.allocations];n?.pk&&(o=o.filter(R=>R.install_into==n.pk));let r=0,_=i.quantity;return o.forEach(R=>{r+=R.quantity}),n?.quantity&&i.bom_item_detail&&(_=n.quantity*i.bom_item_detail.quantity),{...i,filteredAllocations:o,requiredQuantity:_,allocatedQuantity:r}}),[n]),pe=l.useMemo(()=>({allowMultiple:!0,expandable:({record:t})=>a.isRowExpanded(t.pk)||t.allocatedQuantity>0,content:({record:t})=>s.jsx(lt,{lineItem:t,onEditAllocation:i=>{g(i),C.open()},onDeleteAllocation:i=>{g(i),N.open()}})}),[a.isRowExpanded,n]);return s.jsxs(s.Fragment,{children:[m.modal,Q.modal,f.modal,y.modal,C.modal,N.modal,H.modal,Z.wizard,s.jsx(K,{url:B(k.build_line_list),tableState:a,columns:F,props:{params:{...S,build:c.pk,assembly_detail:!1,part_detail:!0},tableActions:me,tableFilters:O,rowActions:ue,dataFormatter:_e,enableDownload:!0,enableSelection:!0,enableLabels:!0,modelType:w.buildline,detailAction:!1,onCellClick:()=>{},rowExpansion:pe}})]})}export{lt as B,Ct as P,St as a};
//# sourceMappingURL=BuildLineTable-CaaXgy5P.js.map
