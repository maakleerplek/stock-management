import{K as Y,r as d,ab as l,an as E,ao as P,az as $,j as e,e as O,av as I,S as b,N as v,ac as D,bc as B,d as k,c as u,O as S,$ as J,am as N,ay as G,aw as Q,C as H,be as X,cy as Z,aa as V,T as R,aj as ee,bg as te,M as se}from"./index-DjOBj_Ai.js";import{k as ae,at as ie,a8 as re,z as q,A as le,E as ne}from"./ThemeContext-BjJu0IKI.js";import{u as oe,L as M}from"./DesktopAppView-D6tHFi_e.js";import{j as ce,a6 as de,h as K,a7 as pe}from"./Filter-CpWhllKn.js";import{a as ue}from"./OrderPartsWizard-CtcPC0ec.js";import{S as me}from"./StockItemTable-D_Czm6nE.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M12 5l0 14",key:"svg-0"}],["path",{d:"M18 13l-6 6",key:"svg-1"}],["path",{d:"M6 13l6 6",key:"svg-2"}]],_e=Y("outline","arrow-down","ArrowDown",xe);function fe({create:t=!1,duplicatePartInstance:i}){const s=$();return d.useMemo(()=>{const o={category:{filters:{structural:!1}},name:{},IPN:{},description:{},revision:{},revision_of:{filters:{is_revision:!1,is_template:!1}},variant_of:{filters:{is_template:!0}},keywords:{},units:{},link:{},default_location:{filters:{structural:!1}},default_expiry:{},minimum_stock:{},responsible:{filters:{is_active:!0}},component:{},assembly:{},is_template:{},testable:{},trackable:{},purchaseable:{},salable:{},virtual:{},locked:{},active:{},starred:{field_type:"boolean",label:l._({id:"7VIaU3"}),description:l._({id:"wyHaGh"}),disabled:!1,required:!1}};return t&&(o.copy_category_parameters={},o.initial_stock={icon:e.jsx(ae,{}),children:{quantity:{value:0},location:{}}},o.initial_supplier={icon:e.jsx(ie,{}),children:{supplier:{filters:{is_supplier:!0}},sku:{},manufacturer:{filters:{is_manufacturer:!0}},mpn:{}}}),t&&i?.pk&&(o.duplicate={icon:e.jsx(re,{}),children:{part:{value:i?.pk,hidden:!0},copy_image:{value:!0},copy_bom:{value:s.isSet("PART_COPY_BOM"),hidden:!i?.assembly},copy_notes:{value:!0},copy_parameters:{value:s.isSet("PART_COPY_PARAMETERS")},copy_tests:{value:!0,hidden:!i?.testable}}}),s.isSet("PART_REVISION_ASSEMBLY_ONLY")&&(o.revision_of.filters.assembly=!0),s.isSet("PART_ENABLE_REVISION")||(delete o.revision,delete o.revision_of),s.isSet("STOCK_ENABLE_EXPIRY")||delete o.default_expiry,t&&delete o.starred,o},[t,i,s])}function we({create:t}){return d.useMemo(()=>{const s={parent:{description:l._({id:"oATGL2"}),required:!1},name:{},description:{},default_location:{filters:{structural:!1}},default_keywords:{},structural:{},starred:{field_type:"boolean",label:l._({id:"7VIaU3"}),description:l._({id:"8Qu8gC"}),disabled:!1,required:!1},icon:{field_type:"icon"}};return t&&delete s.starred,s},[t])}function ze({editTemplate:t}){const i=oe(),[s,o]=d.useState([]),[r,c]=d.useState("string");return d.useMemo(()=>({part:{disabled:!0},template:{disabled:t==!1,onValueChange:(_,p)=>{if(p?.checkbox)o([]),c("boolean");else if(p?.choices){const j=p.choices.split(",");j.length>0?(o(j.map(f=>({display_name:f.trim(),value:f.trim()}))),c("choice")):(o([]),c("string"))}else p?.selectionlist?i.get(E(P.selectionlist_detail,p.selectionlist)).then(j=>{o(j.data.choices.map(f=>({value:f.value,display_name:f.label}))),c("choice")}):(o([]),c("string"))}},data:{type:r,field_type:r,choices:r==="choice"?s:void 0,default:r==="boolean"?!1:void 0,adjustValue:_=>{let p=_.toString().trim();return r==="boolean"&&p.toLowerCase()!=="true"&&(p="false"),p}},note:{}}),[t,r,s])}function Ae(){return{part:{hidden:!0},quantity:{},item_count:{},cost_min:{},cost_min_currency:{},cost_max:{},cost_max_currency:{},note:{}}}const U=({searchResult:t,partId:i,rightSection:s})=>e.jsx(J,{withBorder:!0,p:"md",shadow:"xs",children:e.jsxs(v,{justify:"space-between",align:"flex-start",gap:"xs",children:[t.image_url&&e.jsx("img",{src:t.image_url,alt:t.name,style:{maxHeight:"50px"}}),e.jsxs(b,{gap:0,flex:1,children:[e.jsx("a",{href:t.link,target:"_blank",rel:"noopener noreferrer",children:e.jsxs(k,{size:"lg",w:500,children:[t.name," (",t.sku,")"]})}),e.jsx(k,{size:"sm",children:t.description})]}),e.jsxs(v,{gap:"xs",children:[t.price&&e.jsx(k,{size:"sm",c:"primary",children:t.price}),t.exact&&e.jsx(N,{size:"sm",color:"green",children:e.jsx(u,{id:"yixoBN"})}),t.existing_part_id&&i&&t.existing_part_id===i&&e.jsx(N,{size:"sm",color:"orange",children:e.jsx(u,{id:"0MGISn"})}),t.existing_part_id&&e.jsx(M,{to:`/part/${t.existing_part_id}`,children:e.jsx(N,{size:"sm",color:"blue",children:e.jsx(u,{id:"JdmfnH"})})}),s]})]})},t.id),he=({selectSupplierPart:t,partId:i})=>{const[s,o]=d.useState(""),[r,c]=d.useState(""),[_,p]=d.useState([]),[j,f]=d.useState(!1),x=le({queryKey:["supplier-import-list"],queryFn:()=>O.get(E(P.plugin_supplier_list)).then(a=>a.data??[]),enabled:!0}),n=d.useCallback(async a=>{if(a.preventDefault(),!s||!r)return;f(!0);const[m,w]=JSON.parse(r),h=await O.get(E(P.plugin_supplier_search),{params:{plugin:m,supplier:w,term:s}});p(h.data??[]),f(!1)},[r,s]);return d.useEffect(()=>{r===""&&x.data&&x.data.length>0&&c(JSON.stringify([x.data[0].plugin_slug,x.data[0].supplier_slug]))},[x.data]),e.jsxs(b,{children:[e.jsx("form",{onSubmit:n,children:e.jsxs(v,{align:"flex-end",children:[e.jsx(G,{"aria-label":"textbox-search-for-part",flex:1,placeholder:"Search for a part",label:l._({id:"A1taO8"}),value:s,onChange:a=>o(a.currentTarget.value)}),e.jsx(Q,{label:l._({id:"PYTEl0"}),value:r,onChange:a=>c(a??""),data:x.data?.map(a=>({value:JSON.stringify([a.plugin_slug,a.supplier_slug]),label:a.supplier_name}))||[],searchable:!0,disabled:x.isLoading||x.isError,placeholder:x.isLoading?l._({id:"Z3FXyt"}):x.isError?l._({id:"0Y+Is4"}):l._({id:"CrA0LQ"})}),e.jsx(S,{color:"blue",disabled:!s||!r,type:"submit",leftSection:e.jsx(ne,{}),children:e.jsx(u,{id:"A1taO8"})})]})}),j&&e.jsx(H,{children:e.jsx(X,{})}),!j&&e.jsx(k,{size:"sm",c:"dimmed",children:e.jsx(u,{id:"hDRU5q",values:{0:_.length}})}),e.jsx(Z,{style:{maxHeight:"49vh"},children:e.jsx(b,{gap:"xs",children:_.map(a=>e.jsx(U,{searchResult:a,partId:i,rightSection:!a.existing_part_id&&e.jsx(V,{label:l._({id:"NC6mK/"}),children:e.jsx(D,{"aria-label":`action-button-import-part-${a.id}`,onClick:()=>{const[m,w]=JSON.parse(r);t({plugin:m,supplier:w,searchResult:a})},children:e.jsx(_e,{size:18})})})},a.id))})})]})},ge=({categoryId:t,importPart:i,isImporting:s})=>{const[o,r]=d.useState(t);return e.jsxs(b,{children:[e.jsx(K,{fieldDefinition:{field_type:"related field",api_url:E(P.category_list),description:"",label:l._({id:"mkvLrG"}),model:B.partcategory,filters:{structural:!1},value:o,onValueChange:c=>r(c)}}),e.jsx(k,{children:e.jsx(u,{id:"5frVbW"})}),e.jsx(v,{justify:"flex-end",children:e.jsx(S,{"aria-label":"action-button-import-part-now",disabled:!o||s,onClick:()=>i(o),loading:s,children:e.jsx(u,{id:"N4/gep"})})})]})},je=({importResult:t,isImporting:i,skipStep:s,importParameters:o,parameterErrors:r})=>{const[c,_]=d.useState(()=>t.parameters.map(n=>({...n,use:n.parameter_template!==null}))),[p,j]=d.useMemo(()=>{const n=c.filter(m=>m.on_category&&m.use).length,a=c.filter(m=>!m.on_category&&m.use).length;return[n,a]},[c]),f=d.useMemo(()=>c.filter(n=>n.on_category).length,[c]),x=d.useCallback((n,a)=>m=>_(w=>w.map((h,y)=>n===y?{...h,[a]:m}:h)),[]);return e.jsxs(b,{children:[e.jsx(k,{size:"sm",children:e.jsx(u,{id:"VzTIlR"})}),f>0&&e.jsxs(R,{order:5,children:[e.jsx(u,{id:"DTAucM"}),e.jsx(N,{ml:"xs",children:p})]}),e.jsxs(b,{gap:"xs",children:[c.map((n,a)=>e.jsxs(b,{children:[n.on_category===!1&&c[a-1]?.on_category===!0&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{}),e.jsxs(R,{order:5,children:[e.jsx(u,{id:"UjFzc9"}),e.jsx(N,{ml:"xs",children:j})]})]}),e.jsxs(v,{align:"center",gap:"xs",children:[e.jsx(te,{checked:n.use,onChange:m=>x(a,"use")(m.currentTarget.checked)}),!n.on_category&&e.jsx(V,{label:n.name,children:e.jsx(k,{w:"160px",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:n.name})}),e.jsx(se,{flex:1,children:e.jsx(K,{hideLabels:!0,fieldDefinition:{field_type:"related field",model:B.partparametertemplate,api_url:E(P.part_parameter_template_list),disabled:n.on_category,value:n.parameter_template,onValueChange:m=>{n.parameter_template||x(a,"use")(!0),x(a,"parameter_template")(m)},error:r?.[a]?.template}})}),e.jsx(G,{flex:1,value:n.value,onChange:m=>x(a,"value")(m.currentTarget.value),error:r?.[a]?.data})]})]},a)),e.jsx(V,{label:l._({id:"7Czm8D"}),children:e.jsx(D,{onClick:()=>{_(n=>[...n,{name:"",value:"",parameter_template:null,on_category:!1,use:!0}])},children:e.jsx(pe,{size:18})})})]}),e.jsxs(v,{justify:"flex-end",children:[e.jsx(S,{onClick:s,children:e.jsx(u,{id:"6Uau97"})}),e.jsx(S,{"aria-label":"action-button-import-create-parameters",disabled:i||c.filter(n=>n.use).length===0,loading:i,onClick:()=>o(c),children:e.jsx(u,{id:"OxbLDC"})})]})]})},ye=({importResult:t,nextStep:i})=>e.jsxs(b,{children:[e.jsx(k,{size:"sm",children:e.jsx(u,{id:"KsybX7"})}),e.jsx(me,{tableName:"initial-stock-creation",allowAdd:!0,showPricing:!0,showLocation:!0,params:{part:t.part_id,supplier_part:t.supplier_part_id,pricing:t.pricing,openNewStockItem:!1}}),e.jsx(v,{justify:"flex-end",children:e.jsx(S,{onClick:i,"aria-label":"action-button-import-stock-next",children:e.jsx(u,{id:"hXzOVo"})})})]});function Te({categoryId:t,partId:i}){const[s,o]=d.useState(),[r,c]=d.useState(),[_,p]=d.useState(!1),[j,f]=d.useState(null),x=fe({create:!1}),n=ce({url:P.part_list,pk:r?.part_id,title:l._({id:"enG3o5"}),fields:x}),a=d.useCallback(async({categoryId:y,partId:C})=>{p(!0);try{const z=await O.post(E(P.plugin_supplier_import),{category_id:y,part_import_id:s?.searchResult.id,plugin:s?.plugin,supplier:s?.supplier,part_id:C},{timeout:3e4});c(z.data),I({title:l._({id:"zzDlyQ"}),message:l._({id:"rzfSHc"}),color:"green"}),h.nextStep(),p(!1)}catch(z){I({title:l._({id:"SlfejT"}),message:l._({id:"Ey9Wx7"})+(z?.response?.data?.detail||z.message),color:"red"}),p(!1)}},[s]),m=d.useCallback(y=>e.jsxs(b,{gap:"xs",children:[n.modal,y>0&&s&&e.jsx(U,{searchResult:s?.searchResult,partId:i,rightSection:r&&e.jsxs(v,{gap:"xs",children:[e.jsx(M,{to:`/part/${r.part_id}`,target:"_blank",children:e.jsx(q,{icon:"part"})}),e.jsx(D,{onClick:()=>{n.open()},children:e.jsx(q,{icon:"edit"})})]})}),y===0&&e.jsx(he,{selectSupplierPart:C=>{o(C),h.nextStep()},partId:i}),!i&&y===1&&e.jsx(ge,{isImporting:_,categoryId:t,importPart:C=>{a({categoryId:C})}}),!!i&&y===1&&e.jsxs(b,{children:[e.jsx(de,{model:B.part,pk:i}),e.jsx(k,{children:e.jsx(u,{id:"nS8G62"})}),e.jsx(v,{justify:"flex-end",children:e.jsx(S,{disabled:_,onClick:()=>{a({partId:i})},loading:_,children:e.jsx(u,{id:"l3s5ri"})})})]}),!i&&y===2&&e.jsx(je,{importResult:r,isImporting:_,parameterErrors:j,importParameters:async C=>{p(!0),f(null);const z=C.map((g,L)=>({...g,i:L})).filter(g=>g.use),F=z.reduce((g,L,A)=>(g[L.i]=A,g),{}),W=z.map(g=>({part:r.part_id,template:g.parameter_template,data:g.value}));try{await O.post(E(P.part_parameter_list),W),I({title:l._({id:"zzDlyQ"}),message:l._({id:"Io0Vgf"}),color:"green"}),h.nextStep(),p(!1)}catch(g){if(g?.response?.status===400&&Array.isArray(g.response.data)){const L=g.response.data.map(A=>{const T={};return A.data&&(T.data=A.data.join(",")),A.template&&(T.template=A.template.join(",")),T});f(C.map((A,T)=>F[T]!==void 0&&L[F[T]]?L[F[T]]:{}))}I({title:l._({id:"SlfejT"}),message:l._({id:"RxnKd7"}),color:"red"}),p(!1)}},skipStep:()=>h.nextStep()}),y===(i?2:3)&&e.jsx(ye,{importResult:r,nextStep:()=>h.nextStep()}),y===(i?3:4)&&e.jsxs(b,{children:[e.jsx(k,{size:"sm",children:e.jsx(u,{id:"lzPS7p",values:{0:s?.supplier}})}),e.jsxs(v,{justify:"flex-end",children:[e.jsx(S,{component:M,to:`/part/${r?.part_id}`,variant:"light","aria-label":"action-button-import-open-part",children:e.jsx(u,{id:"lPyajd"})}),e.jsx(S,{component:M,to:`/purchasing/supplier-part/${r?.supplier_part_id}`,variant:"light",children:e.jsx(u,{id:"G9OJle"})}),e.jsx(S,{component:M,to:`/purchasing/manufacturer-part/${r?.manufacturer_part_id}`,variant:"light",children:e.jsx(u,{id:"MFoUdE"})}),e.jsx(S,{onClick:()=>h.closeWizard(),"aria-label":"action-button-import-close",children:e.jsx(u,{id:"yz7wBu"})})]})]})]}),[i,t,s,r,_,j,a,n.modal]),w=d.useCallback(()=>{o(void 0),c(void 0),p(!1),f(null),h.setStep(0)},[]),h=ue({title:l._({id:"rLfAc4"}),steps:[l._({id:"shWt6f"}),...i?[l._({id:"NhdTPX"})]:[l._({id:"K7tIrx"}),l._({id:"F18WP3"})],l._({id:"blbbPS"}),l._({id:"DPfwMq"})],onClose:w,renderStep:m,disableManualStepChange:!0});return h}export{Te as I,fe as a,Ae as b,we as p,ze as u};
//# sourceMappingURL=ImportPartWizard-ANfVbVcJ.js.map
