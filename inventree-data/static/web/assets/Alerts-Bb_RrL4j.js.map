{"version":3,"file":"Alerts-Bb_RrL4j.js","sources":["../../../../../../frontend/src/components/nav/Alerts.tsx"],"sourcesContent":["import { ActionIcon, Alert, Group, Menu, Stack, Tooltip } from '@mantine/core';\nimport { IconExclamationCircle } from '@tabler/icons-react';\nimport { useMemo, useState } from 'react';\n\nimport type { SettingsStateProps } from '@lib/types/Settings';\nimport { t } from '@lingui/core/macro';\nimport { useShallow } from 'zustand/react/shallow';\nimport { docLinks } from '../../defaults/links';\nimport { useServerApiState } from '../../states/ServerApiState';\nimport { useGlobalSettingsState } from '../../states/SettingsStates';\nimport { useUserState } from '../../states/UserState';\nimport type { ServerAPIProps } from '../../states/states';\n\ninterface AlertInfo {\n  key: string;\n  title: string;\n  code?: string;\n  message: string;\n  error?: boolean;\n}\n\n/**\n * The `Alerts` component displays a menu of alerts for staff users based on the server state\n * and global settings. Alerts are shown as a dropdown menu with actionable items that can be dismissed.\n *\n * Dismissed alerts are filtered out and will not reappear in the current session.\n *\n * @returns A dropdown menu of alerts for staff users or `null` if there are no alerts or the user is not a staff member.\n */\nexport function Alerts() {\n  const user = useUserState();\n  const [server] = useServerApiState(useShallow((state) => [state.server]));\n  const globalSettings = useGlobalSettingsState();\n\n  const [dismissed, setDismissed] = useState<string[]>([]);\n\n  const alerts: AlertInfo[] = useMemo(\n    () =>\n      getAlerts(server, globalSettings).filter(\n        (alert) => !dismissed.includes(alert.key)\n      ),\n    [server, dismissed, globalSettings]\n  );\n\n  const anyErrors: boolean = useMemo(\n    () => alerts.some((alert) => alert.error),\n    [alerts]\n  );\n  function closeAlert(key: string) {\n    setDismissed([...dismissed, key]);\n  }\n\n  if (user.isStaff() && alerts.length > 0)\n    return (\n      <Menu withinPortal={true} position='bottom-end'>\n        <Menu.Target>\n          <Tooltip position='bottom-end' label={t`Alerts`}>\n            <ActionIcon\n              variant='transparent'\n              aria-label='open-alerts'\n              color={anyErrors ? 'red' : 'orange'}\n            >\n              <IconExclamationCircle />\n            </ActionIcon>\n          </Tooltip>\n        </Menu.Target>\n        <Menu.Dropdown>\n          {alerts.map((alert) => (\n            <Menu.Item key={`alert-item-${alert.key}`}>\n              <ServerAlert alert={alert} closeAlert={closeAlert} />\n            </Menu.Item>\n          ))}\n        </Menu.Dropdown>\n      </Menu>\n    );\n  return null;\n}\n\nexport function ServerAlert({\n  alert,\n  closeAlert\n}: { alert: AlertInfo; closeAlert?: (key: string) => void }) {\n  return (\n    <Alert\n      withCloseButton={!!closeAlert}\n      color={alert.error ? 'red' : 'orange'}\n      title={\n        <Group gap='xs'>\n          {alert.code && `${alert.code}: `}\n          {alert.title}\n        </Group>\n      }\n      onClose={closeAlert ? () => closeAlert(alert.key) : undefined}\n    >\n      <Stack gap='xs'>\n        {alert.message}\n        {alert.code && errorCodeLink(alert.code)}\n      </Stack>\n    </Alert>\n  );\n}\n\ntype ExtendedAlertInfo = AlertInfo & {\n  condition: boolean;\n};\n\nexport function getAlerts(\n  server: ServerAPIProps,\n  globalSettings: SettingsStateProps,\n  inactive = false\n): ExtendedAlertInfo[] {\n  const n_migrations =\n    Number.parseInt(globalSettings.getSetting('_PENDING_MIGRATIONS')) ?? 0;\n\n  const allalerts: ExtendedAlertInfo[] = [\n    {\n      key: 'debug',\n      title: t`Debug Mode`,\n      code: 'INVE-W4',\n      message: t`The server is running in debug mode.`,\n      condition: server?.debug_mode || false\n    },\n    {\n      key: 'worker',\n      title: t`Background Worker`,\n      code: 'INVE-W5',\n      message: t`The background worker process is not running.`,\n      condition: !server?.worker_running\n    },\n    {\n      key: 'restart',\n      title: t`Server Restart`,\n      code: 'INVE-W6',\n      message: t`The server requires a restart to apply changes.`,\n      condition: globalSettings.isSet('SERVER_RESTART_REQUIRED')\n    },\n    {\n      key: 'email',\n      title: t`Email settings`,\n      code: 'INVE-W7',\n      message: t`Email settings not configured.`,\n      condition: !server?.email_configured\n    },\n    {\n      key: 'migrations',\n      title: t`Database Migrations`,\n      code: 'INVE-W8',\n      message: t`There are pending database migrations.`,\n      condition: n_migrations > 0\n    }\n  ];\n\n  return allalerts.filter((alert) => inactive || alert.condition);\n}\n\nexport function errorCodeLink(code: string) {\n  return (\n    <a\n      href={`${docLinks.errorcodes}#${code.toLowerCase()}`}\n      target='_blank'\n      rel='noreferrer'\n    >\n      {t`Learn more about ${code}`}\n    </a>\n  );\n}\n"],"names":["Alerts","user","useUserState","server","useServerApiState","useShallow","state","globalSettings","useGlobalSettingsState","dismissed","setDismissed","useState","alerts","useMemo","getAlerts","filter","alert","includes","key","anyErrors","some","error","closeAlert","isStaff","length","jsxs","Menu","jsx","Tooltip","_i18n","_","id","ActionIcon","IconExclamationCircle","map","ServerAlert","Alert","Group","code","title","undefined","Stack","message","errorCodeLink","inactive","n_migrations","Number","parseInt","getSetting","condition","debug_mode","worker_running","isSet","email_configured","docLinks","errorcodes","toLowerCase","values"],"mappings":"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"}