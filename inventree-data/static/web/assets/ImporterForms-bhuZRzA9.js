import{r,ao as b,bc as P,bV as A,j as e,ab as n,an as w,N as g,d as j,a7 as G,bP as v,a8 as Q,S,$ as V,al as y,bh as U,O as N,aq as O,ak as x,aw as Y,C as $,be as H,aj as J,ba as K,cx as C}from"./index-DjOBj_Ai.js";import{u as W}from"./UseInstance-BYH4ds5B.js";import{u as q}from"./UseStatusCodes-BH1R2YPA.js";import{ad as L,S as B}from"./ThemeContext-BjJu0IKI.js";import{A as X}from"./ActionButton-D4nRdKaB.js";import{P as Z}from"./index-_kfXKtfq.js";import{u as ee,R as se,a as te,I as re}from"./InvenTreeTable-C-s5lvnS.js";import{Y as le}from"./YesNoButton-CYsvXLSb.js";import{u as M}from"./DesktopAppView-D6tHFi_e.js";import{j as ae,e as ie,a6 as ne,h as oe,a8 as de}from"./Filter-CpWhllKn.js";import{b as z}from"./IconChevronDown-I6OOyduR.js";import{I as ce}from"./IconCircleDashedCheck-FiF_1OHY.js";function ue(t,s,{autoInvoke:i=!1}={}){const[o,c]=r.useState(!1),d=r.useRef(null),u=r.useRef(null),p=r.useCallback(()=>{c(_=>(!_&&(!d.current||d.current===-1)&&(d.current=window.setInterval(u.current,s)),!0))},[]),f=r.useCallback(()=>{c(!1),window.clearInterval(d.current||-1),d.current=-1},[]),m=r.useCallback(()=>{o?f():p()},[o]);return r.useEffect(()=>(u.current=t,o&&p(),f),[t,o,s]),r.useEffect(()=>{i&&p()},[]),{start:p,stop:f,toggle:m,active:o}}function pe({sessionId:t}){const{instance:s,setInstance:i,refreshInstance:o,instanceQuery:c}=W({endpoint:b.import_session_list,pk:t,defaultValue:{}}),d=r.useCallback(a=>{i(a)},[]);q({modelType:P.importsession});const[u,p]=r.useState(0);r.useEffect(()=>{p(0)},[t]),r.useEffect(()=>{s.status&&s.status!==u&&p(s.status)},[s?.status]);const f=r.useMemo(()=>s?.available_fields??[],[s]),m=r.useMemo(()=>{let a=s?.columns??[];return a=a.filter(l=>!!l),a=a.filter((l,h)=>a.indexOf(l)===h),a},[s.columns]),_=r.useMemo(()=>{let a=s?.column_mappings?.map(l=>({...l,...f[l.field]??{}}))??[];return a=a.sort((l,h)=>l?.required&&!h?.required?-1:!l?.required&&h?.required?1:0),a},[s,m]),k=r.useMemo(()=>s?.column_mappings?.filter(a=>!!a.column)??[],[s]),T=r.useMemo(()=>s?.field_defaults??{},[s]),D=r.useMemo(()=>s?.field_overrides??{},[s]),R=r.useMemo(()=>s?.field_filters??{},[s]),F=r.useMemo(()=>s?.row_count??0,[s]),E=r.useMemo(()=>s?.completed_row_count??0,[s]);return{sessionData:s,setSessionData:d,sessionId:t,refreshSession:o,sessionQuery:c,status:u,availableFields:f,availableColumns:m,columnMappings:_,mappedFields:k,fieldDefaults:T,fieldOverrides:D,fieldFilters:R,rowCount:F,completedRowCount:E}}function fe({session:t,column:s,row:i,onEdit:o}){const c=r.useCallback(f=>{U(f),i.complete||o?.()},[o,i]),d=r.useMemo(()=>i.errors?i?.errors[s.field]??[]:[],[i.errors,s.field]),u=r.useMemo(()=>{const f=t.availableFields[s.field];if(!i?.data)return"-";switch(f?.type){case"boolean":return e.jsx(le,{value:i.data?i.data[s.field]:!1});case"related field":if(f.model&&i.data[s.field])return e.jsx(ne,{model:f.model,pk:i.data[s.field]});break}let m=i.data?i.data[s.field]??"":"";return m||(m="-"),m},[i.data,s.field,t.availableFields]),p=r.useMemo(()=>d.length==0,[d]);return e.jsxs(v,{disabled:p,openDelay:100,closeDelay:100,children:[e.jsx(v.Target,{children:e.jsx(g,{grow:!0,justify:"apart",onClick:c,children:e.jsx(g,{grow:!0,style:{flex:1},children:e.jsx(j,{size:"xs",c:p?void 0:"red",children:u})})})}),e.jsx(v.Dropdown,{children:e.jsx(S,{gap:"xs",children:d.map(f=>e.jsx(j,{size:"xs",c:"red",children:f},f))})})]})}function he({session:t}){const s=M(),i=ee("dataimporter"),[o,c]=r.useState([]),d=r.useMemo(()=>{const a={};for(const l of o){const h=t.availableFields[l];if(h){let I=h.filters??{};if(t.fieldFilters[l]&&(I={...I,...t.fieldFilters[l]}),l=="id")continue;a[l]={...h,field_type:h.type,description:h.help_text,filters:I}}}return a},[o,t.availableFields,t.fieldFilters]),u=r.useCallback(a=>{A.show({title:n._({id:"fawxGh"}),message:n._({id:"SdvoV5"}),autoClose:!1,color:"blue",id:"importing-rows",icon:e.jsx(z,{})}),s.post(w(b.import_session_accept_rows,t.sessionId),{rows:a}).catch(()=>{A.show({title:n._({id:"SlfejT"}),message:n._({id:"aydx5i"}),color:"red",autoClose:!0})}).finally(()=>{i.clearSelectedRecords(),A.hide("importing-rows"),i.refreshTable(),t.refreshSession()})},[t.sessionId,i.refreshTable]),[p,f]=r.useState({}),m=ae({url:b.import_session_row_list,pk:p.pk,title:n._({id:"bo3Q/V"}),fields:d,initialData:p.data,fetchInitialData:!1,processFormData:a=>({data:{...p.data,...a}}),onFormSuccess:a=>i.updateRecord(a)}),_=r.useCallback((a,l)=>{l.field!="id"&&(f(a),c([l.field]),m.open())},[t,m]),k=ie({url:b.import_session_row_list,pk:p.pk,title:n._({id:"f2AJjl"}),onFormSuccess:()=>i.refreshTable()}),T=r.useCallback(a=>{if(!a.errors)return[];const l=[];for(const h of Object.keys(a.errors))a.errors[h]&&(Array.isArray(a.errors[h])?a.errors[h].forEach(I=>{l.push(`${h}: ${I}`)}):l.push(a.errors[h].toString()));return l},[]),D=r.useMemo(()=>[{accessor:"row_index",title:n._({id:"IqKCNQ"}),sortable:!0,switchable:!1,render:l=>e.jsxs(g,{justify:"left",gap:"xs",children:[e.jsx(j,{size:"sm",children:l.row_index}),l.complete&&e.jsx(G,{color:"green",size:16}),!l.complete&&l.valid&&e.jsx(ce,{color:"blue",size:16}),!l.complete&&!l.valid&&e.jsxs(v,{openDelay:50,closeDelay:100,position:"top-start",children:[e.jsx(v.Target,{children:e.jsx(Q,{color:"red",size:16})}),e.jsx(v.Dropdown,{children:e.jsxs(S,{gap:"xs",children:[e.jsxs(j,{children:[n._({id:"H14AdY"}),":"]}),T(l).map(h=>e.jsx(j,{size:"sm",c:"red",children:h},h))]})})]})]})},...t.mappedFields.map(l=>({accessor:l.field,title:l.label??l.column,sortable:!1,switchable:!0,render:h=>e.jsx(fe,{session:t,column:l,row:h,onEdit:()=>_(h,l)})}))],[t]),R=r.useCallback(a=>[{title:n._({id:"g3UF2V"}),icon:e.jsx(z,{}),color:"green",hidden:a.complete||!a.valid,onClick:()=>{u([a.pk])}},se({hidden:a.complete,onClick:()=>{f(a),c(t.mappedFields.map(l=>l.field)),m.open()}}),te({onClick:()=>{f(a),k.open()}})],[t,u]),F=r.useMemo(()=>[{name:"valid",label:n._({id:"nfagfM"}),description:n._({id:"p385PV"}),type:"boolean"},{name:"complete",label:n._({id:"bD8I7O"}),description:n._({id:"ytCibL"}),type:"boolean"}],[]),E=r.useMemo(()=>{const a=i.hasSelectedRecords&&i.selectedRecords.every(l=>l.valid&&!l.complete);return[e.jsx(X,{disabled:!a,icon:e.jsx(z,{}),color:"green",tooltip:n._({id:"Fgr3ay"}),onClick:()=>{u(i.selectedRecords.map(l=>l.pk))}},"import-selected-rows")]},[i.hasSelectedRecords,i.selectedRecords]);return e.jsxs(e.Fragment,{children:[m.modal,k.modal,e.jsxs(S,{gap:"xs",children:[e.jsx(V,{shadow:"xs",p:"xs",children:e.jsxs(g,{grow:!0,justify:"apart",children:[e.jsx(j,{size:"lg",children:n._({id:"6dO0jk"})}),e.jsx(y,{}),e.jsx(Z,{maximum:t.rowCount,value:t.completedRowCount,progressLabel:!0}),e.jsx(y,{})]})}),e.jsx(re,{tableState:i,columns:D,url:w(b.import_session_row_list),props:{params:{session:t.sessionId},rowActions:R,tableActions:E,tableFilters:F,enableColumnSwitching:!0,enableColumnCaching:!1,enableSelection:!0,enableBulkDelete:!0,afterBulkDelete:()=>{t.refreshSession()}}})]})]})}function me({column:t,options:s}){const i=M(),[o,c]=r.useState(""),[d,u]=r.useState(t.column??"");r.useEffect(()=>{u(t.column??"")},[t.column]);const p=r.useCallback(f=>{i.patch(w(b.import_session_column_mapping_list,t.pk),{column:f||""}).then(m=>{u(m.data?.column??f),c("")}).catch(m=>{const _=m.response.data;c(_.column??_.non_field_errors??n._({id:"Vw8l6h"}))})},[t]);return e.jsx(Y,{"aria-label":`import-column-map-${t.field}`,error:o,clearable:!0,searchable:!0,placeholder:n._({id:"TJu1/1"}),label:void 0,data:s,value:d,onChange:p})}function xe({fieldName:t,session:s}){const i=M(),o=r.useCallback(d=>{const u={...s.fieldDefaults,[t]:d};i.patch(w(b.import_session_list,s.sessionId),{field_defaults:u}).then(p=>{s.setSessionData(p.data)}).catch(()=>{})},[t,s,s.fieldDefaults]),c=r.useMemo(()=>{let d=s.availableFields[t];return d&&(d={...d,value:s.fieldDefaults[t],field_type:d.type,description:d.help_text,onValueChange:o}),d},[t,s.availableFields,s.fieldDefaults]);return c&&e.jsx(oe,{fieldDefinition:c,hideLabels:!0})}function je({session:t,column:s,options:i}){return e.jsxs(x.Tr,{children:[e.jsx(x.Td,{children:e.jsxs(g,{gap:"xs",children:[e.jsx(j,{fw:s.required?700:void 0,children:s.label??s.field}),s.required&&e.jsx(j,{c:"red",fw:700,children:"*"})]})}),e.jsx(x.Td,{children:e.jsx(j,{size:"sm",children:s.description})}),e.jsx(x.Td,{children:e.jsx(me,{column:s,options:i})}),e.jsx(x.Td,{children:e.jsx(xe,{fieldName:s.field,session:t})})]},s.label??s.field)}function _e({session:t}){const s=M(),[i,o]=r.useState(""),c=r.useCallback(()=>{const u=w(b.import_session_accept_fields,t.sessionId);s.post(u).then(()=>{t.refreshSession()}).catch(p=>{o(p.response?.data?.error??n._({id:"Vw8l6h"}))})},[t.sessionId]),d=r.useMemo(()=>[{value:"",label:n._({id:"ojDp4A"})},...t.availableColumns.map(u=>({value:u,label:u}))],[t.availableColumns]);return e.jsxs(S,{gap:"xs",children:[e.jsx(V,{shadow:"xs",p:"xs",children:e.jsxs(g,{grow:!0,justify:"apart",children:[e.jsx(j,{size:"lg",children:n._({id:"AHjxLx"})}),e.jsx(y,{}),e.jsx(N,{color:"green",variant:"filled",onClick:c,children:e.jsxs(g,{children:[e.jsx(L,{}),n._({id:"Y+Sfcf"})]})})]})}),i&&e.jsx(O,{color:"red",title:n._({id:"SlfejT"}),children:e.jsx(j,{children:i})}),e.jsxs(x,{children:[e.jsx(x.Thead,{children:e.jsxs(x.Tr,{children:[e.jsx(x.Th,{children:n._({id:"3mVQ03"})}),e.jsx(x.Th,{children:n._({id:"Us9epU"})}),e.jsx(x.Th,{children:n._({id:"qsUkVg"})}),e.jsx(x.Th,{children:n._({id:"aQ8swY"})})]})}),e.jsx(x.Tbody,{children:t.columnMappings.map(u=>e.jsx(je,{session:t,column:u,options:d},`import-${u.field}}`))})]})]})}function be({session:t}){const s=r.useMemo(()=>de(P.importsession,t.status)||n._({id:"SC1Cur"}),[t.status]);return ue(()=>{t.refreshSession()},1e3,{autoInvoke:!0}),e.jsx($,{style:{height:"100%"},children:e.jsxs(S,{gap:"xs",align:"center",justify:"center",children:[e.jsx(B,{size:"lg",children:s}),e.jsx(H,{})]})})}function Se({currentStep:t}){return e.jsxs(C,{active:t,onStepClick:void 0,allowNextStepsSelect:!1,iconSize:20,size:"xs",children:[e.jsx(C.Step,{label:n._({id:"IQ3gAw"})}),e.jsx(C.Step,{label:n._({id:"KXVPhI"})}),e.jsx(C.Step,{label:n._({id:"FhMhTR"})}),e.jsx(C.Step,{label:n._({id:"eHQfWJ"})}),e.jsx(C.Step,{label:n._({id:"b8ESNU"})})]})}function Ee({sessionId:t,opened:s,onClose:i}){const o=pe({sessionId:t}),c=q({modelType:P.importsession}),d=r.useMemo(()=>{switch(o.status){case c.INITIAL:return 0;case c.MAPPING:return 1;case c.IMPORTING:return 2;case c.PROCESSING:return 3;case c.COMPLETE:return 4;default:return 0}},[o.status]),u=r.useMemo(()=>{if(o.sessionQuery.isError)return e.jsx(O,{color:"red",title:n._({id:"SlfejT"}),icon:e.jsx(Q,{}),children:n._({id:"mfQdnw"})});switch(o.status){case c.MAPPING:return e.jsx(_e,{session:o});case c.PROCESSING:return e.jsx(he,{session:o});case c.COMPLETE:return e.jsxs(S,{gap:"xs",children:[e.jsx(O,{color:"green",title:n._({id:"4fgz8U"}),icon:e.jsx(L,{}),children:n._({id:"zdT9Dy"})}),e.jsx(N,{color:"blue",onClick:i,children:n._({id:"yz7wBu"})})]});default:return e.jsx(be,{session:o})}},[o.status,o.sessionQuery]),p=r.useMemo(()=>e.jsxs(S,{gap:"xs",style:{width:"100%"},children:[e.jsxs(g,{gap:"xs",wrap:"nowrap",justify:"space-apart",grow:!0,preventGrowOverflow:!1,children:[e.jsx(B,{size:"lg",children:o.sessionData?.statusText??n._({id:"CTRRU5"})}),e.jsx(Se,{currentStep:d}),e.jsx(y,{})]}),e.jsx(J,{})]}),[o.sessionData]);return e.jsx(K,{position:"bottom",size:"80%",title:p,opened:s,onClose:i,withCloseButton:!0,closeOnEscape:!1,closeOnClickOutside:!1,styles:{header:{width:"100%"},title:{width:"100%"}},children:e.jsx(S,{gap:"xs",children:e.jsx(V,{p:"md",children:u})})})}function Ae({modelType:t,allowUpdate:s=!1}){return{data_file:{},model_type:{value:t,hidden:t!=null},update_records:{hidden:s!==!0,value:s?void 0:!1},field_defaults:{hidden:!0,value:{}},field_overrides:{hidden:!0,value:{}},field_filters:{hidden:!0,value:{}}}}export{Ee as I,Ae as d};
//# sourceMappingURL=ImporterForms-bhuZRzA9.js.map
